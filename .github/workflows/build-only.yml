name: Build (No Release)

on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm libfuse2
          sudo gem install --no-document fpm

      - name: Install appimagetool
        run: |
          curl -fsSL -o /tmp/appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool
          sudo mv /tmp/appimagetool /usr/local/bin/appimagetool

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build Linux x64
        run: |
          dotnet restore
          dotnet publish -c Release -r linux-x64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            -o artifacts/linux-x64

      - name: Build Linux arm64
        run: |
          dotnet publish -c Release -r linux-arm64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            -o artifacts/linux-arm64

      - name: Create tar.gz archives
        run: |
          cd artifacts/linux-x64 && tar -czf ../HyPrism-linux-x64.tar.gz . && cd ../..
          cd artifacts/linux-arm64 && tar -czf ../HyPrism-linux-arm64.tar.gz . && cd ../..

      - name: Create .deb package
        run: |
          mkdir -p pkg/opt/hyprism pkg/usr/bin pkg/usr/share/applications pkg/usr/share/icons/hicolor/256x256/apps
          cp -R artifacts/linux-x64/* pkg/opt/hyprism/
          chmod +x pkg/opt/hyprism/HyPrism
          ln -sf /opt/hyprism/HyPrism pkg/usr/bin/hyprism
          ln -sf /opt/hyprism/HyPrism pkg/usr/bin/HyPrism
          cp packaging/flatpak/dev.hyprism.HyPrism.desktop pkg/usr/share/applications/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.png pkg/usr/share/icons/hicolor/256x256/apps/ || true
          fpm -s dir -t deb -n hyprism -v 0.0.0 -C pkg \
            --description "HyPrism - Hytale Launcher" \
            --url "https://github.com/HyPrism/HyPrism" \
            -p artifacts/HyPrism-linux-x64.deb .

      - name: Create .rpm package
        run: |
          fpm -s dir -t rpm -n hyprism -v 0.0.0 -C pkg \
            --description "HyPrism - Hytale Launcher" \
            --url "https://github.com/HyPrism/HyPrism" \
            -p artifacts/HyPrism-linux-x64.rpm .

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/lib/hyprism AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp -R artifacts/linux-x64/* AppDir/usr/lib/hyprism/
          chmod +x AppDir/usr/lib/hyprism/HyPrism
          ln -sf ../lib/hyprism/HyPrism AppDir/usr/bin/HyPrism
          cp packaging/flatpak/dev.hyprism.HyPrism.desktop AppDir/usr/share/applications/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.png AppDir/usr/share/icons/hicolor/256x256/apps/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.png AppDir/ || true
          cat > AppDir/AppRun << 'EOF'
          #!/bin/sh
          exec "$(dirname "$0")/usr/lib/hyprism/HyPrism" "$@"
          EOF
          chmod +x AppDir/AppRun
          ln -sf usr/share/applications/dev.hyprism.HyPrism.desktop AppDir/HyPrism.desktop || true
          ARCH=x86_64 appimagetool -n AppDir artifacts/HyPrism-linux-x64.AppImage

      - name: Build Flatpak
        run: |
          set -e
          # Prepare bundle from linux-x64 artifacts (place into packaging/flatpak so manifest sources match)
          rm -rf packaging/flatpak/bundle || true
          mkdir -p packaging/flatpak/bundle
          cp -R artifacts/linux-x64/* packaging/flatpak/bundle/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.* packaging/flatpak/bundle/ || true
          chmod +x packaging/flatpak/bundle/HyPrism || true

          # Sanity check: ensure HyPrism binary is present and executable
          if [ ! -x packaging/flatpak/bundle/HyPrism ]; then
            echo "ERROR: packaging/flatpak/bundle/HyPrism missing or not executable"
            ls -la packaging/flatpak/bundle || true
            exit 1
          fi

          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          # Ensure flathub remote available for runtime downloads
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true

          # Build the Flatpak repo and create a single bundle file
          flatpak-builder --force-clean --repo=repo builddir packaging/flatpak/dev.hyprism.HyPrism.json
          flatpak build-bundle repo artifacts/HyPrism.flatpak dev.hyprism.HyPrism || true

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            artifacts/HyPrism-linux-x64.tar.gz
            artifacts/HyPrism-linux-arm64.tar.gz
            artifacts/HyPrism-linux-x64.deb
            artifacts/HyPrism-linux-x64.rpm
            artifacts/HyPrism-linux-x64.AppImage
            artifacts/HyPrism.flatpak

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build Windows x64
        run: |
          dotnet restore
          dotnet publish -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true /p:PublishReadyToRun=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            -o artifacts/win-x64

      - name: Create Windows zip
        run: |
          Compress-Archive -Path artifacts/win-x64/* -DestinationPath artifacts/HyPrism-windows-x64.zip

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: artifacts/HyPrism-windows-x64.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build macOS arm64
        run: |
          dotnet publish -c Release -r osx-arm64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            -o artifacts/osx-arm64

      - name: Debug - List build outputs
        run: |
          echo "=== osx-arm64 contents ==="
          ls -la artifacts/osx-arm64/ || echo "osx-arm64 directory missing"

      - name: Create macOS app bundle
        run: |
          set -e
          
          mkdir -p "artifacts/HyPrism.app/Contents/MacOS"
          mkdir -p "artifacts/HyPrism.app/Contents/Resources"
          
          if [ ! -f "artifacts/osx-arm64/HyPrism" ]; then
            echo "ERROR: HyPrism binary not found!"
            ls -la artifacts/osx-arm64/
            exit 1
          fi
          
          cp artifacts/osx-arm64/HyPrism "artifacts/HyPrism.app/Contents/MacOS/"
          cp -R artifacts/osx-arm64/wwwroot "artifacts/HyPrism.app/Contents/Resources/"
          cp artifacts/osx-arm64/jre.json "artifacts/HyPrism.app/Contents/Resources/" || true
          cp packaging/macos/Info.plist "artifacts/HyPrism.app/Contents/"
          cp packaging/macos/HyPrism.icns "artifacts/HyPrism.app/Contents/Resources/"
          chmod +x "artifacts/HyPrism.app/Contents/MacOS/HyPrism"
          
          echo "APPL????" > "artifacts/HyPrism.app/Contents/PkgInfo"
          
          echo "=== App bundle created ==="
          ls -la "artifacts/HyPrism.app/Contents/MacOS/"

      - name: Create DMG
        run: |
          mkdir -p dmg
          cp -R "artifacts/HyPrism.app" "dmg/HyPrism.app"
          
          # Create helper script to clear quarantine
          cat > "dmg/Open_HyPrism.command" << 'EOF'
          #!/bin/bash
          APP="$(dirname "$0")/HyPrism.app"
          xattr -cr "$APP"
          open "$APP"
          EOF
          chmod +x "dmg/Open_HyPrism.command"
          
          ln -s /Applications dmg/Applications
          hdiutil create -volname "HyPrism" -srcfolder dmg -ov -format UDZO artifacts/HyPrism-macos-arm64.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: artifacts/HyPrism-macos-arm64.dmg
